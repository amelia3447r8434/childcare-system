
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FDB813',
            primaryDark: '#E5A511',
            secondary: '#FEF3C7',
            accent: '#FBBF24',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
    .heart-checkbox {
      appearance: none;
      width: 32px;
      height: 32px;
      cursor: pointer;
      position: relative;
    }
    .heart-checkbox::before {
      content: 'ğŸ¤';
      font-size: 28px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .heart-checkbox:checked::before {
      content: 'â¤ï¸';
    }
  </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 min-h-screen">
  <div id="app"></div>

  <script>
    // Supabase è¨­å®š
    const SUPABASE_URL = 'https://utszytwaabadivssondj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0c3p5dHdhYWJhZGl2c3NvbmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMzQ1MDIsImV4cCI6MjA3NzkxMDUwMn0.Tq2RlCaOegGV7I8jYqgFLHOLpm-bic1RTuIpRzuwqaY';

    // è©•åƒ¹é …ç›®å®šç¾©
    const EVALUATION_ITEMS = {
      communication: [
        { key: 'communication_1', text: 'æ¸…æ¥šè¡¨é”æ‰˜è‚²ç†å¿µåŠæ‰˜è‚²å…§å®¹' },
        { key: 'communication_2', text: 'ä¸»å‹•åˆ†äº«å¹¼å…’ç”Ÿæ´»èˆ‡æˆé•·ç‹€æ³' },
        { key: 'communication_3', text: 'ç•¶æœ‰ç‰¹æ®Šç‹€æ³æ™‚(å¦‚:ç”Ÿç—…ã€å—å‚·),èƒ½å³æ™‚è¯çµ¡' },
        { key: 'communication_4', text: 'ç•¶æˆ‘æœ‰ç–‘å•æ™‚,æ‰˜è‚²äººå“¡èƒ½ç¢ºå¯¦å›è¦†' },
        { key: 'communication_5', text: 'èˆ‡æ‰˜è‚²äººå“¡æºé€šå¤§è‡´æµæš¢è‰¯å¥½' }
      ],
      activity: [
        { key: 'activity_1', text: 'æä¾›å­©å­å¤§è‡´å®‰å…¨çš„æ´»å‹•ç’°å¢ƒ' },
        { key: 'activity_2', text: 'èƒ½å®‰æ’ä¿ƒé€²å­©å­ç™¼å±•çš„æ´»å‹•' },
        { key: 'activity_3', text: 'èƒ½è€ƒé‡å­©å­çš„ç‰¹è³ªèª¿æ•´æ´»å‹•' },
        { key: 'activity_4', text: 'èƒ½æä¾›æ•™æã€ç©å…·çµ¦å­©å­ä½¿ç”¨' },
        { key: 'activity_5', text: 'æä¾›å¤šå…ƒè±å¯Œçš„æ‰˜è‚²æ´»å‹•' }
      ],
      routine: [
        { key: 'routine_1', text: 'å”åŠ©å­©å­å»ºç«‹è‰¯å¥½ä½œæ¯(å¦‚:åƒã€ç¡ç­‰)' },
        { key: 'routine_2', text: 'å¹«åŠ©å­©å­é¤Šæˆè‰¯å¥½ç”Ÿæ´»ç¿’æ…£(å¦‚:ä¸æŒ‘é£Ÿã€å‹¤æ´—æ‰‹ç­‰)' },
        { key: 'routine_3', text: 'èƒ½å¹«åŠ©å­©å­å»ºç«‹è·Ÿå…¶ä»–å­©å­ç›¸è™•çš„èƒ½åŠ›' },
        { key: 'routine_4', text: 'ä¾å­©å­ç™¼å±•æƒ…æ³å”åŠ©å»ºç«‹è‡ªç†èƒ½åŠ›(å¦‚:ç”¨é¤ã€å¦‚å»ã€æ”¶æ‹¾)' },
        { key: 'routine_5', text: 'ç•¶å­©å­æœ‰è¡Œç‚ºå•é¡Œæ™‚,èƒ½å¦¥é©è¼”å°(å¦‚:å’¬äººã€æ‰“äºº)' }
      ],
      relationship: [
        { key: 'relationship_1', text: 'èƒ½è€ƒé‡æˆ‘çš„éœ€æ±‚,å½ˆæ€§èª¿æ•´æ‰˜è‚²å…§å®¹' },
        { key: 'relationship_2', text: 'èƒ½å…±åŒè¨è«–è‚²å…’å•é¡Œã€å”å•†è™•ç†æ–¹å¼' },
        { key: 'relationship_3', text: 'æ‰˜è‚²äººå“¡èƒ½å°Šé‡æˆ‘çš„æ•™è‚²ç†å¿µèˆ‡æ•™é¤Šæ–¹å¼' },
        { key: 'relationship_4', text: 'æˆ‘æ„Ÿè¦ºèˆ‡æ‰˜è‚²äººå“¡æ˜¯å¤¥ä¼´é—œä¿‚' },
        { key: 'relationship_5', text: 'æˆ‘ç›¸ä¿¡å­©å­å—åˆ°å¦¥å–„çš„ç…§é¡§' }
      ]
    };

    // åœ–ç¤º SVG
    const icons = {
      home: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
      user: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
      logout: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
      news: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>',
      megaphone: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 11 18-5v12L3 14v-3z"></path><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path></svg>',
      heart: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',
      star: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>'
    };

    // ç‹€æ…‹ç®¡ç†
    let state = {
      user: null,
      userRole: null, // 'provider' or 'parent'
      providerData: null,
      parentData: null,
      assignedProviders: [],
      currentEvaluation: null,
      selectedProvider: null,
      evaluationStats: null,
      news: [],
      currentPage: 'home',
      error: ''
    };

    // åˆå§‹åŒ–
    function init() {
      checkUser();
      fetchNews();
      render();
    }

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    function checkUser() {
      const storedUser = sessionStorage.getItem('childcare_user');
      if (storedUser) {
        state.user = JSON.parse(storedUser);
        state.userRole = state.user.role;
        if (state.userRole === 'provider') {
          fetchProviderData();
        } else if (state.userRole === 'parent') {
          fetchParentData();
        }
      }
    }

    // ç²å–æœ€æ–°æ¶ˆæ¯
    async function fetchNews() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/news?select=*&order=published_date.desc`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        if (response.ok) {
          state.news = await response.json();
          render();
        }
      } catch (error) {
        console.error('ç²å–æ¶ˆæ¯å¤±æ•—:', error);
      }
    }

    // ç²å–æ‰˜è‚²äººå“¡è³‡æ–™
    async function fetchProviderData() {
      if (!state.user) return;
      
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?user_id=eq.${state.user.id}&select=*`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${state.user.token}`
          }
        });
        if (response.ok) {
          const data = await response.json();
          state.providerData = data[0];
          await fetchEvaluationStats();
          render();
        }
      } catch (error) {
        console.error('ç²å–è³‡æ–™å¤±æ•—:', error);
      }
    }

    // ç²å–æ‰˜è‚²äººå“¡çš„è©•åƒ¹çµ±è¨ˆ
    async function fetchEvaluationStats() {
      if (!state.providerData) return;
      
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/provider_evaluation_stats?provider_id=eq.${state.providerData.id}&select=*`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${state.user.token}`
          }
        });
        if (response.ok) {
          const data = await response.json();
          state.evaluationStats = data[0] || null;
          render();
        }
      } catch (error) {
        console.error('ç²å–è©•åƒ¹çµ±è¨ˆå¤±æ•—:', error);
      }
    }

    // ç²å–å®¶é•·è³‡æ–™
    async function fetchParentData() {
      if (!state.user) return;
      
      console.log('=== é–‹å§‹ç²å–å®¶é•·è³‡æ–™ ===');
      console.log('User ID:', state.user.id);
      
      try {
        // ç²å–å®¶é•·åŸºæœ¬è³‡æ–™
        const parentRes = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=eq.${state.user.id}&select=*`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${state.user.token}`
          }
        });
        
        console.log('å®¶é•·è³‡æ–™æŸ¥è©¢ç‹€æ…‹:', parentRes.status);
        
        if (parentRes.ok) {
          const parentData = await parentRes.json();
          console.log('âœ… å®¶é•·è³‡æ–™:', parentData);
          state.parentData = parentData[0];
        } else {
          console.error('âŒ ç²å–å®¶é•·è³‡æ–™å¤±æ•—');
        }

        // ç²å–å¯è©•åƒ¹çš„æ‰˜è‚²äººå“¡
        console.log('æº–å‚™ç²å–åˆ†é…çš„æ‰˜è‚²äººå“¡...');
        await fetchAssignedProviders();
        
        console.log('=== å®¶é•·è³‡æ–™ç²å–å®Œæˆ ===');
        render();
      } catch (error) {
        console.error('âŒ ç²å–å®¶é•·è³‡æ–™å¤±æ•—:', error);
      }
    }

    // ç²å–å®¶é•·å¯è©•åƒ¹çš„æ‰˜è‚²äººå“¡
    async function fetchAssignedProviders() {
      if (!state.user) return;
      
      try {
        console.log('=== é–‹å§‹ç²å–åˆ†é…çš„æ‰˜è‚²äººå“¡ ===');
        console.log('User ID:', state.user.id);
        console.log('Token:', state.user.token.substring(0, 20) + '...');
        
        // å…ˆç²å–åˆ†é…é—œä¿‚
        const assignmentUrl = `${SUPABASE_URL}/rest/v1/parent_provider_assignments?parent_user_id=eq.${state.user.id}&select=provider_id`;
        console.log('æŸ¥è©¢ URL:', assignmentUrl);
        
        const assignmentRes = await fetch(assignmentUrl, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${state.user.token}`
          }
        });
        
        console.log('åˆ†é…é—œä¿‚æŸ¥è©¢ç‹€æ…‹:', assignmentRes.status, assignmentRes.statusText);
        
        if (!assignmentRes.ok) {
          const errorText = await assignmentRes.text();
          console.error('âŒ ç²å–åˆ†é…é—œä¿‚å¤±æ•—:', errorText);
          alert('ç„¡æ³•è®€å–åˆ†é…è³‡æ–™ã€‚è«‹æª¢æŸ¥ RLS æ”¿ç­–è¨­å®šã€‚\néŒ¯èª¤ï¼š' + errorText);
          state.assignedProviders = [];
          render();
          return;
        }
        
        const assignments = await assignmentRes.json();
        console.log('âœ… åˆ†é…é—œä¿‚è³‡æ–™:', assignments);
        console.log('åˆ†é…æ•¸é‡:', assignments.length);
        
        if (assignments.length === 0) {
          console.log('âš ï¸ æ²’æœ‰åˆ†é…é—œä¿‚');
          state.assignedProviders = [];
          render();
          return;
        }
        
        // ç²å–æ‰˜è‚²äººå“¡ ID åˆ—è¡¨
        const providerIds = assignments.map(a => a.provider_id);
        console.log('æ‰˜è‚²äººå“¡ IDs:', providerIds);
        
        // æŸ¥è©¢æ‰€æœ‰åˆ†é…çš„æ‰˜è‚²äººå“¡è³‡æ–™
        const providerUrl = `${SUPABASE_URL}/rest/v1/child_care_providers?id=in.(${providerIds.join(',')})&select=*`;
        console.log('æŸ¥è©¢ URL:', providerUrl);
        
        const providerRes = await fetch(providerUrl, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${state.user.token}`
          }
        });
        
        console.log('æ‰˜è‚²äººå“¡æŸ¥è©¢ç‹€æ…‹:', providerRes.status, providerRes.statusText);
        
        if (providerRes.ok) {
          const providers = await providerRes.json();
          console.log('âœ… æ‰˜è‚²äººå“¡è³‡æ–™:', providers);
          console.log('æ‰˜è‚²äººå“¡æ•¸é‡:', providers.length);
          
          if (providers.length === 0) {
            console.log('âš ï¸ æŸ¥è©¢åˆ°åˆ†é…é—œä¿‚ï¼Œä½†æ‰¾ä¸åˆ°å°æ‡‰çš„æ‰˜è‚²äººå“¡è³‡æ–™');
          }
          
          state.assignedProviders = providers;
          render();
        } else {
          const errorText = await providerRes.text();
          console.error('âŒ ç²å–æ‰˜è‚²äººå“¡è³‡æ–™å¤±æ•—:', errorText);
          alert('ç„¡æ³•è®€å–æ‰˜è‚²äººå“¡è³‡æ–™ã€‚\néŒ¯èª¤ï¼š' + errorText);
          state.assignedProviders = [];
          render();
        }
      } catch (error) {
        console.error('âŒ ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('ç³»çµ±éŒ¯èª¤ï¼š' + error.message);
        state.assignedProviders = [];
        render();
      }
    }

    // ç²å–å°ç‰¹å®šæ‰˜è‚²äººå“¡çš„è©•åƒ¹
    async function fetchEvaluation(providerId) {
      if (!state.user) return;
      
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/evaluations?parent_user_id=eq.${state.user.id}&provider_id=eq.${providerId}&select=*`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${state.user.token}`
            }
          }
        );
        if (response.ok) {
          const data = await response.json();
          state.currentEvaluation = data[0] || null;
          render();
        }
      } catch (error) {
        console.error('ç²å–è©•åƒ¹å¤±æ•—:', error);
      }
    }

    // å„²å­˜è©•åƒ¹
    async function saveEvaluation(providerId, evaluationData) {
      if (!state.user) return;
      
      try {
        const method = state.currentEvaluation ? 'PATCH' : 'POST';
        const url = state.currentEvaluation 
          ? `${SUPABASE_URL}/rest/v1/evaluations?id=eq.${state.currentEvaluation.id}`
          : `${SUPABASE_URL}/rest/v1/evaluations`;

        const body = state.currentEvaluation 
          ? { ...evaluationData, updated_at: new Date().toISOString() }
          : { ...evaluationData, parent_user_id: state.user.id, provider_id: providerId };

        const response = await fetch(url, {
          method: method,
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${state.user.token}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(body)
        });

        if (response.ok) {
          alert('è©•åƒ¹å·²å„²å­˜ï¼');
          await fetchEvaluation(providerId);
        } else {
          const error = await response.json();
          alert('å„²å­˜å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('å„²å­˜è©•åƒ¹å¤±æ•—:', error);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ç™»å…¥
    async function handleLogin(email, password) {
      state.error = '';
      if (!email || !password) {
        state.error = 'è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼';
        render();
        return;
      }

      try {
        console.log('=== é–‹å§‹ç™»å…¥æµç¨‹ ===');
        console.log('Email:', email);
        
        // æ­¥é©Ÿ 1: é€²è¡Œèº«ä»½é©—è­‰
        const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        const authData = await authResponse.json();
        console.log('Auth å›æ‡‰ç‹€æ…‹:', authResponse.status);
        
        if (!authData.access_token) {
          state.error = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
          console.log('âŒ ç™»å…¥å¤±æ•—');
          render();
          return;
        }

        const userId = authData.user.id;
        const token = authData.access_token;
        console.log('âœ… Auth æˆåŠŸ, User ID:', userId);

        // æ­¥é©Ÿ 2: åˆ¤æ–·ä½¿ç”¨è€…èº«ä»½ï¼ˆæª¢æŸ¥æ˜¯æ‰˜è‚²äººå“¡é‚„æ˜¯å®¶é•·ï¼‰
        let userRole = null;
        
        console.log('æª¢æŸ¥æ˜¯å¦ç‚ºæ‰˜è‚²äººå“¡...');
        // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºæ‰˜è‚²äººå“¡
        const providerCheck = await fetch(`${SUPABASE_URL}/rest/v1/child_care_providers?user_id=eq.${userId}&select=id`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (providerCheck.ok) {
          const providerData = await providerCheck.json();
          console.log('æ‰˜è‚²äººå“¡æŸ¥è©¢çµæœ:', providerData);
          if (providerData.length > 0) {
            userRole = 'provider';
            console.log('âœ… èº«ä»½ï¼šæ‰˜è‚²äººå“¡');
          }
        }

        // å¦‚æœä¸æ˜¯æ‰˜è‚²äººå“¡ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºå®¶é•·
        if (!userRole) {
          console.log('æª¢æŸ¥æ˜¯å¦ç‚ºå®¶é•·...');
          const parentCheck = await fetch(`${SUPABASE_URL}/rest/v1/parents?user_id=eq.${userId}&select=id`, {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (parentCheck.ok) {
            const parentData = await parentCheck.json();
            console.log('å®¶é•·æŸ¥è©¢çµæœ:', parentData);
            if (parentData.length > 0) {
              userRole = 'parent';
              console.log('âœ… èº«ä»½ï¼šå®¶é•·');
            }
          }
        }

        // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰èº«ä»½
        if (!userRole) {
          state.error = 'æ­¤å¸³è™Ÿæœªè¨»å†Šç‚ºæ‰˜è‚²äººå“¡æˆ–å®¶é•·';
          console.log('âŒ æ‰¾ä¸åˆ°å°æ‡‰èº«ä»½');
          render();
          return;
        }

        // æ­¥é©Ÿ 3: å„²å­˜ç™»å…¥ç‹€æ…‹
        state.user = { 
          id: userId, 
          email: authData.user.email, 
          token: token,
          role: userRole
        };
        state.userRole = userRole;
        sessionStorage.setItem('childcare_user', JSON.stringify(state.user));
        
        console.log('=== ç™»å…¥ç‹€æ…‹å·²å„²å­˜ ===');
        console.log('Role:', userRole);
        
        // æ­¥é©Ÿ 4: å°å‘å°æ‡‰é é¢ä¸¦ç²å–è³‡æ–™
        if (userRole === 'provider') {
          console.log('è¼‰å…¥æ‰˜è‚²äººå“¡è³‡æ–™...');
          state.currentPage = 'profile';
          await fetchProviderData();
        } else {
          console.log('è¼‰å…¥å®¶é•·è³‡æ–™...');
          state.currentPage = 'evaluate';
          await fetchParentData();
        }
        
        console.log('=== ç™»å…¥æµç¨‹å®Œæˆ ===');
      } catch (error) {
        console.error('âŒ ç™»å…¥éŒ¯èª¤:', error);
        state.error = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        render();
      }
    }

    // ç™»å‡º
    function handleLogout() {
      state.user = null;
      state.userRole = null;
      state.providerData = null;
      state.parentData = null;
      state.assignedProviders = [];
      state.currentEvaluation = null;
      state.selectedProvider = null;
      state.currentPage = 'home';
      sessionStorage.removeItem('childcare_user');
      render();
    }

    // åˆ‡æ›é é¢
    function navigateTo(page) {
      state.currentPage = page;
      state.error = '';
      state.selectedProvider = null;
      state.currentEvaluation = null;
      render();
    }

    // é¸æ“‡è¦è©•åƒ¹çš„æ‰˜è‚²äººå“¡
    async function selectProvider(provider) {
      state.selectedProvider = provider;
      await fetchEvaluation(provider.id);
      state.currentPage = 'evaluate-detail';
      render();
    }

    // æ¸²æŸ“é é¢
    function render() {
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <!-- å°èˆªåˆ— -->
        <nav class="bg-gradient-to-r from-yellow-400 via-amber-400 to-yellow-500 shadow-lg">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
              <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md">
                  <span class="text-2xl">ğŸ‘¶</span>
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-white drop-shadow-md">æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•«</h1>
                  <p class="text-xs text-yellow-100">Child Care Provider Incentive Pilot Program</p>
                </div>
              </div>
              
              <div class="flex items-center space-x-4">
                ${state.user ? `
                  <button onclick="navigateTo('home')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition ${state.currentPage === 'home' ? 'bg-white text-yellow-600' : 'text-white hover:bg-yellow-500'}">
                    ${icons.home}
                    <span class="hidden sm:inline">é¦–é </span>
                  </button>
                  ${state.userRole === 'provider' ? `
                    <button onclick="navigateTo('profile')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition ${state.currentPage === 'profile' ? 'bg-white text-yellow-600' : 'text-white hover:bg-yellow-500'}">
                      ${icons.user}
                      <span class="hidden sm:inline">å€‹äººè³‡æ–™</span>
                    </button>
                  ` : ''}
                  ${state.userRole === 'parent' ? `
                    <button onclick="navigateTo('evaluate')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition ${state.currentPage.startsWith('evaluate') ? 'bg-white text-yellow-600' : 'text-white hover:bg-yellow-500'}">
                      ${icons.heart}
                      <span class="hidden sm:inline">è©•åƒ¹æ‰˜è‚²äººå“¡</span>
                    </button>
                  ` : ''}
                  <button onclick="handleLogout()" class="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                    ${icons.logout}
                    <span class="hidden sm:inline">ç™»å‡º</span>
                  </button>
                ` : `
                  <button onclick="navigateTo('home')" class="flex items-center space-x-2 px-4 py-2 rounded-lg transition ${state.currentPage === 'home' ? 'bg-white text-yellow-600' : 'text-white hover:bg-yellow-500'}">
                    ${icons.home}
                    <span>é¦–é </span>
                  </button>
                  <button onclick="navigateTo('login')" class="px-6 py-2 bg-white text-yellow-600 rounded-lg font-semibold hover:bg-yellow-50 transition shadow-md">
                    ç™»å…¥
                  </button>
                `}
              </div>
            </div>
          </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          ${state.currentPage === 'home' ? renderHomePage() : ''}
          ${state.currentPage === 'login' ? renderLoginPage() : ''}
          ${state.currentPage === 'profile' ? renderProfilePage() : ''}
          ${state.currentPage === 'evaluate' ? renderEvaluatePage() : ''}
          ${state.currentPage === 'evaluate-detail' ? renderEvaluateDetailPage() : ''}
        </main>

        <!-- é å°¾ -->
        <footer class="bg-gradient-to-r from-yellow-400 via-amber-400 to-yellow-500 mt-20">
          <div class="max-w-7xl mx-auto px-4 py-8 text-center text-white">
            <p class="text-sm">Â© 2024 æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•« | Child Care Provider Incentive Pilot Program</p>
            <p class="text-xs mt-2 text-yellow-100">æä¾›å°ˆæ¥­ã€å®‰å…¨ã€æº«é¦¨çš„æ‰˜è‚²æœå‹™</p>
          </div>
        </footer>
      `;
    }

    // é¦–é 
    function renderHomePage() {
      const latestNews = state.news.filter(n => n.category === 'æœ€æ–°æ¶ˆæ¯');
      const policies = state.news.filter(n => n.category === 'æ”¿ç­–å®£å°');
      
      return `
        <div class="space-y-8">
          <!-- æ­¡è¿æ©«å¹… -->
          <div class="bg-gradient-to-r from-yellow-300 via-amber-300 to-yellow-400 rounded-2xl shadow-xl p-8 md:p-12 text-center">
            <h2 class="text-4xl md:text-5xl font-bold text-white mb-4 drop-shadow-lg">æ­¡è¿ä¾†åˆ°æ‰˜è‚²äººå“¡é¼“å‹µæ©Ÿåˆ¶è©¦è¾¦è¨ˆç•«</h2>
            <p class="text-lg md:text-xl text-yellow-50 mb-6">æä¾›å°ˆæ¥­çš„æ‰˜è‚²æœå‹™è³‡è¨Šèˆ‡ç®¡ç†å¹³å°</p>
            ${!state.user ? `
              <button onclick="navigateTo('login')" class="px-8 py-3 bg-white text-yellow-600 rounded-full font-bold text-lg hover:bg-yellow-50 transition shadow-lg transform hover:scale-105">
                ç«‹å³ç™»å…¥ â†’
              </button>
            ` : ''}
          </div>

          <div class="grid md:grid-cols-2 gap-8">
            <!-- æœ€æ–°æ¶ˆæ¯ -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-4 border-yellow-400">
              <div class="bg-gradient-to-r from-yellow-400 to-amber-400 px-6 py-4 flex items-center space-x-3">
                <div class="text-white">${icons.news}</div>
                <h3 class="text-2xl font-bold text-white">æœ€æ–°æ¶ˆæ¯</h3>
              </div>
              <div class="p-6 space-y-4">
                ${latestNews.length === 0 ? '<p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰æœ€æ–°æ¶ˆæ¯</p>' : ''}
                ${latestNews.map(news => `
                  <div class="border-l-4 border-yellow-400 pl-4 py-2 hover:bg-yellow-50 transition rounded">
                    <h4 class="font-semibold text-gray-800 mb-1">${news.title}</h4>
                    <p class="text-sm text-gray-600 mb-2">${news.content}</p>
                    <p class="text-xs text-gray-400">${new Date(news.published_date).toLocaleDateString('zh-TW')}</p>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- æ”¿ç­–å®£å° -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-4 border-amber-500">
              <div class="bg-gradient-to-r from-amber-500 to-yellow-500 px-6 py-4 flex items-center space-x-3">
                <div class="text-white">${icons.megaphone}</div>
                <h3 class="text-2xl font-bold text-white">æ”¿ç­–å®£å°</h3>
              </div>
              <div class="p-6 space-y-4">
                ${policies.length === 0 ? '<p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰æ”¿ç­–å®£å°</p>' : ''}
                ${policies.map(news => `
                  <div class="border-l-4 border-amber-500 pl-4 py-2 hover:bg-amber-50 transition rounded">
                    <h4 class="font-semibold text-gray-800 mb-1">${news.title}</h4>
                    <p class="text-sm text-gray-600 mb-2">${news.content}</p>
                    <p class="text-xs text-gray-400">${new Date(news.published_date).toLocaleDateString('zh-TW')}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ç™»å…¥é é¢
    function renderLoginPage() {
      return `
        <div class="max-w-md mx-auto">
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-400 to-amber-400 px-8 py-6 text-center">
              <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span class="text-4xl">ğŸ”</span>
              </div>
              <h2 class="text-3xl font-bold text-white">ç™»å…¥ç³»çµ±</h2>
              <p class="text-yellow-100 mt-2">è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿå¯†ç¢¼</p>
            </div>
            
            <div class="p-8">
              ${state.error ? `
                <div class="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
                  ${state.error}
                </div>
              ` : ''}
              
              <div class="space-y-6">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                  <input type="email" id="email" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-400 focus:outline-none transition">
                </div>
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">å¯†ç¢¼</label>
                  <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                         class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-400 focus:outline-none transition">
                </div>
                
                <button onclick="handleLogin(document.getElementById('email').value, document.getElementById('password').value)"
                        class="w-full py-3 bg-gradient-to-r from-yellow-400 to-amber-400 text-white font-bold rounded-lg hover:from-yellow-500 hover:to-amber-500 transition shadow-lg transform hover:scale-105">
                  ç™»å…¥
                </button>
              </div>
              
              <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-gray-600 mb-3">
                  <strong class="text-yellow-700">æ¸¬è©¦å¸³è™Ÿï¼š</strong>
                </p>
                <div class="text-xs text-gray-600 space-y-1">
                  <p><strong>æ‰˜è‚²äººå“¡ï¼š</strong> provider1@example.com / password123</p>
                  <p><strong>å®¶é•·ï¼š</strong> parent1@example.com / password123</p>
                  <p class="text-yellow-700 mt-2"> ç³»çµ±æœƒè‡ªå‹•åˆ¤æ–·æ‚¨çš„èº«ä»½</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // æ‰˜è‚²äººå“¡å€‹äººè³‡æ–™é é¢
    function renderProfilePage() {
      if (!state.user || state.userRole !== 'provider') {
        navigateTo('login');
        return '';
      }
      
      if (!state.providerData) {
        return `
          <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-12 text-center">
            <div class="animate-spin w-16 h-16 border-4 border-yellow-400 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600">è¼‰å…¥ä¸­...</p>
          </div>
        `;
      }

      const stats = state.evaluationStats;
      const hasEvaluations = stats && stats.total_parents > 0;
      
      return `
        <div class="max-w-4xl mx-auto space-y-6">
          <!-- å€‹äººè³‡æ–™å¡ç‰‡ -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-400 to-amber-400 px-8 py-12 text-center">
              <div class="w-32 h-32 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl border-4 border-yellow-200">
                <span class="text-6xl">${state.providerData.gender === 'ç”·' ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘©â€ğŸ«'}</span>
              </div>
              <h2 class="text-4xl font-bold text-white mb-2">${state.providerData.name}</h2>
              <p class="text-yellow-100 text-lg">@${state.providerData.account}</p>
            </div>
            
            <div class="p-8 space-y-6">
              <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-yellow-50 to-amber-50 p-6 rounded-xl border-2 border-yellow-200">
                  <p class="text-sm font-semibold text-gray-600 mb-2">æ€§åˆ¥</p>
                  <p class="text-2xl font-bold text-gray-800">${state.providerData.gender}</p>
                </div>
                
                <div class="bg-gradient-to-br from-yellow-50 to-amber-50 p-6 rounded-xl border-2 border-yellow-200">
                  <p class="text-sm font-semibold text-gray-600 mb-2">å¸³è™Ÿ</p>
                  <p class="text-2xl font-bold text-gray-800">${state.providerData.account}</p>
                </div>
              </div>
              
              <div class="bg-gradient-to-br from-yellow-50 to-amber-50 p-6 rounded-xl border-2 border-yellow-200">
                <p class="text-sm font-semibold text-gray-600 mb-3">å€‹äººç°¡ä»‹</p>
                <p class="text-gray-700 leading-relaxed text-lg">${state.providerData.introduction}</p>
              </div>
            </div>
          </div>

          <!-- è©•åƒ¹çµ±è¨ˆå¡ç‰‡ -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-pink-400 to-red-400 px-8 py-6 text-center">
              <h3 class="text-3xl font-bold text-white flex items-center justify-center gap-3">
                <span class="text-4xl">â¤ï¸</span>
                å®¶é•·è©•åƒ¹çµ±è¨ˆ
              </h3>
            </div>

            ${!hasEvaluations ? `
              <div class="p-12 text-center">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <p class="text-gray-500 text-lg">å°šæœªæœ‰å®¶é•·è©•åƒ¹</p>
                <p class="text-gray-400 text-sm mt-2">ç­‰å¾…å®¶é•·å¡«å¯«è©•åƒ¹å¾Œï¼Œçµ±è¨ˆè³‡æ–™æœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
              </div>
            ` : `
              <div class="p-8 space-y-6">
                <!-- ç¸½è¦½çµ±è¨ˆ -->
                <div class="grid md:grid-cols-2 gap-6">
                  <div class="bg-gradient-to-br from-red-50 to-pink-50 p-6 rounded-xl border-2 border-red-200 text-center">
                    <p class="text-sm font-semibold text-gray-600 mb-2">ç¸½æ„›å¿ƒæ•¸</p>
                    <p class="text-5xl font-bold text-red-500">${stats.total_hearts || 0}</p>
                    <p class="text-xs text-gray-500 mt-2">â¤ï¸ å…±ç²å¾—çš„è‚¯å®š</p>
                  </div>
                  
                  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 text-center">
                    <p class="text-sm font-semibold text-gray-600 mb-2">è©•åƒ¹äººæ•¸</p>
                    <p class="text-5xl font-bold text-blue-500">${stats.total_parents || 0}</p>
                    <p class="text-xs text-gray-500 mt-2">ğŸ‘¥ ä½å®¶é•·çµ¦äºˆè©•åƒ¹</p>
                  </div>
                </div>

                <!-- å„ä¸»é¡Œçµ±è¨ˆ -->
                <div class="bg-gray-50 rounded-xl p-6">
                  <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>ğŸ“Š</span>
                    å„ä¸»é¡Œç²å¾—æ„›å¿ƒæ•¸
                  </h4>
                  <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-200">
                      <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">ä¸€ã€ä¿è¦ªæºé€š</span>
                        <span class="text-2xl font-bold text-purple-500">${stats.communication_hearts || 0}</span>
                      </div>
                      <div class="mt-2 bg-purple-100 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: ${(stats.communication_hearts || 0) / (stats.total_parents * 5) * 100}%"></div>
                      </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-2 border-green-200">
                      <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">äºŒã€æ‰˜è‚²æ´»å‹•å®‰æ’</span>
                        <span class="text-2xl font-bold text-green-500">${stats.activity_hearts || 0}</span>
                      </div>
                      <div class="mt-2 bg-green-100 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: ${(stats.activity_hearts || 0) / (stats.total_parents * 5) * 100}%"></div>
                      </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-2 border-blue-200">
                      <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">ä¸‰ã€ä½œæ¯å®‰æ’èˆ‡ç”Ÿæ´»ç¿’æ…£</span>
                        <span class="text-2xl font-bold text-blue-500">${stats.routine_hearts || 0}</span>
                      </div>
                      <div class="mt-2 bg-blue-100 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${(stats.routine_hearts || 0) / (stats.total_parents * 5) * 100}%"></div>
                      </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border-2 border-pink-200">
                      <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">å››ã€ä¿è¦ªé—œä¿‚</span>
                        <span class="text-2xl font-bold text-pink-500">${stats.relationship_hearts || 0}</span>
                      </div>
                      <div class="mt-2 bg-pink-100 rounded-full h-2">
                        <div class="bg-pink-500 h-2 rounded-full" style="width: ${(stats.relationship_hearts || 0) / (stats.total_parents * 5) * 100}%"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 flex items-start gap-3">
                  <span class="text-2xl">â„¹ï¸</span>
                  <div class="text-sm text-blue-800">
                    <p class="font-semibold mb-1">è©•åƒ¹èªªæ˜ï¼š</p>
                    <p>å®¶é•·çš„è©•åƒ¹æ˜¯åŒ¿åçš„ï¼Œæ‚¨åªèƒ½çœ‹åˆ°çµ±è¨ˆæ•¸æ“šï¼Œç„¡æ³•å¾—çŸ¥æ˜¯å“ªä½å®¶é•·çµ¦äºˆçš„è©•åƒ¹ã€‚é€™æ˜¯ç‚ºäº†ä¿è­·å®¶é•·çš„éš±ç§ï¼Œä¸¦ç¢ºä¿è©•åƒ¹çš„å®¢è§€æ€§ã€‚</p>
                  </div>
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // å®¶é•·è©•åƒ¹é é¢ï¼ˆåˆ—è¡¨ï¼‰
    function renderEvaluatePage() {
      if (!state.user || state.userRole !== 'parent') {
        navigateTo('login');
        return '';
      }

      if (state.assignedProviders.length === 0) {
        return `
          <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-12 text-center">
            <div class="text-6xl mb-4">ğŸ‘¶</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">å°šæœªåˆ†é…æ‰˜è‚²äººå“¡</h3>
            <p class="text-gray-600">è«‹è¯çµ¡ç®¡ç†å“¡ç‚ºæ‚¨åˆ†é…å¯è©•åƒ¹çš„æ‰˜è‚²äººå“¡</p>
          </div>
        `;
      }

      return `
        <div class="max-w-5xl mx-auto">
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-yellow-400 to-amber-400 px-8 py-6">
              <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                <span>â¤ï¸</span>
                è©•åƒ¹æ‰˜è‚²äººå“¡
              </h2>
              <p class="text-yellow-100 mt-2">é»é¸æ‰˜è‚²äººå“¡é€²è¡Œè©•åƒ¹ï¼Œæ‚¨å¯ä»¥éš¨æ™‚ä¿®æ”¹è©•åƒ¹å…§å®¹</p>
            </div>

            <div class="p-8">
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${state.assignedProviders.map(provider => `
                  <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-xl p-6 border-2 border-yellow-200 hover:border-yellow-400 hover:shadow-lg transition cursor-pointer"
                       onclick="selectProvider(${JSON.stringify(provider).replace(/"/g, '&quot;')})">
                    <div class="flex flex-col items-center text-center">
                      <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-md">
                        <span class="text-4xl">${provider.gender === 'ç”·' ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘©â€ğŸ«'}</span>
                      </div>
                      <h3 class="text-xl font-bold text-gray-800 mb-1">${provider.name}</h3>
                      <p class="text-sm text-gray-600 mb-3">${provider.gender}</p>
                      <button class="px-6 py-2 bg-gradient-to-r from-yellow-400 to-amber-400 text-white font-semibold rounded-lg hover:from-yellow-500 hover:to-amber-500 transition">
                        é–‹å§‹è©•åƒ¹
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // å®¶é•·è©•åƒ¹è©³ç´°é é¢
    function renderEvaluateDetailPage() {
      if (!state.selectedProvider) {
        navigateTo('evaluate');
        return '';
      }

      const provider = state.selectedProvider;
      const evaluation = state.currentEvaluation || {};

      // è¨ˆç®—ç•¶å‰å®¶é•·çµ¦äºˆçš„æ„›å¿ƒæ•¸
      const calculateHearts = (category) => {
        const items = EVALUATION_ITEMS[category];
        let count = 0;
        items.forEach(item => {
          if (evaluation[item.key]) count++;
        });
        return count;
      };

      const communicationHearts = calculateHearts('communication');
      const activityHearts = calculateHearts('activity');
      const routineHearts = calculateHearts('routine');
      const relationshipHearts = calculateHearts('relationship');
      const totalHearts = communicationHearts + activityHearts + routineHearts + relationshipHearts;

      return `
        <div class="max-w-4xl mx-auto">
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- æ‰˜è‚²äººå“¡è³‡è¨Š -->
            <div class="bg-gradient-to-r from-yellow-400 to-amber-400 px-8 py-8">
              <button onclick="navigateTo('evaluate')" class="text-white hover:text-yellow-100 mb-4 flex items-center gap-2">
                â† è¿”å›åˆ—è¡¨
              </button>
              <div class="flex items-center gap-6">
                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg">
                  <span class="text-5xl">${provider.gender === 'ç”·' ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘©â€ğŸ«'}</span>
                </div>
                <div>
                  <h2 class="text-3xl font-bold text-white mb-2">${provider.name}</h2>
                  <p class="text-yellow-100">æ­£åœ¨è©•åƒ¹é€™ä½æ‰˜è‚²äººå“¡</p>
                </div>
              </div>
            </div>

            <!-- å®¶é•·è‡ªå·±çš„è©•åƒ¹çµ±è¨ˆ -->
            ${state.currentEvaluation ? `
              <div class="bg-gradient-to-r from-pink-50 to-red-50 px-8 py-6 border-b-2 border-pink-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <span>ğŸ“Š</span>
                  æ‚¨çµ¦äºˆçš„è©•åƒ¹çµ±è¨ˆ
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                  <div class="bg-white p-4 rounded-lg text-center border-2 border-purple-200">
                    <p class="text-sm text-gray-600 mb-1">ä¿è¦ªæºé€š</p>
                    <p class="text-2xl font-bold text-purple-500">${communicationHearts}/5</p>
                    <p class="text-xs text-gray-500 mt-1">${'â¤ï¸'.repeat(communicationHearts)}${'ğŸ¤'.repeat(5-communicationHearts)}</p>
                  </div>
                  <div class="bg-white p-4 rounded-lg text-center border-2 border-green-200">
                    <p class="text-sm text-gray-600 mb-1">æ‰˜è‚²æ´»å‹•</p>
                    <p class="text-2xl font-bold text-green-500">${activityHearts}/5</p>
                    <p class="text-xs text-gray-500 mt-1">${'â¤ï¸'.repeat(activityHearts)}${'ğŸ¤'.repeat(5-activityHearts)}</p>
                  </div>
                  <div class="bg-white p-4 rounded-lg text-center border-2 border-blue-200">
                    <p class="text-sm text-gray-600 mb-1">ä½œæ¯ç¿’æ…£</p>
                    <p class="text-2xl font-bold text-blue-500">${routineHearts}/5</p>
                    <p class="text-xs text-gray-500 mt-1">${'â¤ï¸'.repeat(routineHearts)}${'ğŸ¤'.repeat(5-routineHearts)}</p>
                  </div>
                  <div class="bg-white p-4 rounded-lg text-center border-2 border-pink-200">
                    <p class="text-sm text-gray-600 mb-1">ä¿è¦ªé—œä¿‚</p>
                    <p class="text-2xl font-bold text-pink-500">${relationshipHearts}/5</p>
                    <p class="text-xs text-gray-500 mt-1">${'â¤ï¸'.repeat(relationshipHearts)}${'ğŸ¤'.repeat(5-relationshipHearts)}</p>
                  </div>
                  <div class="bg-gradient-to-br from-red-100 to-pink-100 p-4 rounded-lg text-center border-2 border-red-300">
                    <p class="text-sm text-gray-600 mb-1">ç¸½æ„›å¿ƒæ•¸</p>
                    <p class="text-3xl font-bold text-red-500">${totalHearts}/20</p>
                    <p class="text-xs text-gray-500 mt-1"> ${Math.round(totalHearts/20*100)}%</p>
                  </div>
                </div>
              </div>
            ` : `
              <div class="bg-yellow-50 px-8 py-4 border-b-2 border-yellow-200">
                <p class="text-yellow-800 flex items-center gap-2">
                  <span>â„¹ï¸</span>
                  æ‚¨å°šæœªè©•åƒ¹é€™ä½æ‰˜è‚²äººå“¡ï¼Œå¡«å¯«å¾Œå°‡é¡¯ç¤ºæ‚¨çš„è©•åƒ¹çµ±è¨ˆ
                </p>
              </div>
            `}

            <!-- è©•åƒ¹è¡¨å–® -->
            <div class="p-8">
              <form id="evaluationForm" onsubmit="handleSubmitEvaluation(event, '${provider.id}')">
                ${renderEvaluationSection('ä¸€ã€ä¿è¦ªæºé€š', 'communication', EVALUATION_ITEMS.communication, evaluation)}
                ${renderEvaluationSection('äºŒã€æ‰˜è‚²æ´»å‹•å®‰æ’', 'activity', EVALUATION_ITEMS.activity, evaluation)}
                ${renderEvaluationSection('ä¸‰ã€ä½œæ¯å®‰æ’èˆ‡ç”Ÿæ´»ç¿’æ…£', 'routine', EVALUATION_ITEMS.routine, evaluation)}
                ${renderEvaluationSection('å››ã€ä¿è¦ªé—œä¿‚', 'relationship', EVALUATION_ITEMS.relationship, evaluation)}

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="mt-8 flex gap-4">
                  <button type="submit" class="flex-1 py-4 bg-gradient-to-r from-yellow-400 to-amber-400 text-white font-bold text-lg rounded-lg hover:from-yellow-500 hover:to-amber-500 transition shadow-lg">
                    ğŸ’¾ å„²å­˜è©•åƒ¹
                  </button>
                  <button type="button" onclick="navigateTo('evaluate')" class="px-8 py-4 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">
                    å–æ¶ˆ
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    // æ¸²æŸ“è©•åƒ¹å€å¡Š
    function renderEvaluationSection(title, category, items, evaluation) {
      return `
        <div class="mb-8 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border-2 border-gray-200">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“‹</span>
            ${title}
          </h3>
          <div class="space-y-3">
            ${items.map(item => `
              <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-yellow-400 transition">
                <label class="flex items-center gap-4 cursor-pointer">
                  <input type="checkbox" 
                         name="${item.key}" 
                         class="heart-checkbox"
                         ${evaluation[item.key] ? 'checked' : ''}>
                  <span class="text-gray-700 flex-1">${item.text}</span>
                </label>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // è™•ç†è©•åƒ¹è¡¨å–®æäº¤
    function handleSubmitEvaluation(event, providerId) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const evaluationData = {};
      
      // æ”¶é›†æ‰€æœ‰è©•åƒ¹é …ç›®
      Object.values(EVALUATION_ITEMS).flat().forEach(item => {
        evaluationData[item.key] = formData.has(item.key);
      });

      saveEvaluation(providerId, evaluationData);
    }

    // å•Ÿå‹•æ‡‰ç”¨
    init();
  </script>
</body>
</html>
